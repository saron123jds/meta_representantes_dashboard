<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meta Representantes - Metas Individuais</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="brand-mark">MR</span>
      <div>
        <strong>Meta Representantes</strong>
        <span>Cadastro de metas</span>
      </div>
    </div>
    <nav class="topnav">
      <a href="/">Dashboard</a>
      <a href="/admin">Admin</a>
      <a class="active" href="/admin/metas">Metas</a>
    </nav>
  </header>

  <section class="hero hero-admin">
    <div class="hero-content">
      <div>
        <p class="eyebrow">Administração</p>
        <h1>Metas individuais por representante</h1>
        <p class="subtitle">Cadastre metas de valor e pedidos por período. Os dados são salvos localmente em <strong>/data/metas.json</strong>.</p>
      </div>
      <div class="hero-card">
        <h3>Relatório ativo</h3>
        {% if latest_file %}
        <p class="hero-value">{{ latest_file }}</p>
        {% if updated_at %}
        <p class="caption">Atualizado em {{ updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
        {% endif %}
        {% else %}
        <p class="caption">Nenhum arquivo carregado ainda.</p>
        {% endif %}
        {% if metas_updated_at %}
        <p class="caption">Última atualização das metas: {{ metas_updated_at.replace('T', ' ') }}</p>
        {% endif %}
      </div>
    </div>
  </section>

  <main class="dashboard admin-page">
    <section class="grid admin-grid">
      <div class="card admin-card">
        <h2>Selecionar período</h2>
        <p class="caption">Escolha o mês/ano das metas que deseja cadastrar ou revisar.</p>
        <form class="period-form" method="get">
          <label class="form-field" for="periodo">
            <span>Período (YYYY-MM)</span>
            <input id="periodo" name="periodo" type="month" value="{{ periodo }}" required>
          </label>
          <button class="btn-primary" type="submit">Carregar</button>
        </form>
      </div>
      <div class="card admin-info">
        <h3>Resumo do período</h3>
        <p class="caption">Período selecionado:</p>
        <p class="path-pill">{{ periodo }}</p>
        <ul class="info-list">
          <li>Metas ficam salvas por período no arquivo local.</li>
          <li>Se um representante não possuir meta, será marcado como pendente.</li>
          <li>Atualize o CSV para refletir novos representantes.</li>
        </ul>
      </div>
    </section>

    <section class="card admin-card admin-table">
      <div class="section-header">
        <div>
          <h2>Metas por representante</h2>
          <p class="caption">Valores vazios deixam a meta como pendente.</p>
        </div>
        <div class="action-row">
          <div class="inline-field">
            <label for="metaPadrao">Aplicar meta padrão (R$)</label>
            <input id="metaPadrao" type="text" placeholder="Ex: 100.000,00">
          </div>
          <button class="btn-secondary" type="button" id="applyDefault">Aplicar</button>
        </div>
      </div>

      {% if not representantes %}
      <div class="alert info">Nenhum representante encontrado. Atualize o CSV na página Admin.</div>
      {% else %}
      <form method="post" class="meta-form">
        <input type="hidden" name="periodo" value="{{ periodo }}">
        <input type="hidden" name="rep_total" value="{{ representantes|length }}">
        <div class="table-wrapper meta-table">
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th>Representante</th>
                <th>Meta (R$)</th>
                <th>Meta pedidos</th>
                <th>Status</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for rep in representantes %}
              <tr>
                <td>{{ rep.codigo }}</td>
                <td>
                  <div class="rep-info">
                    <strong>{{ rep.nome }}</strong>
                    <span class="caption">ID: {{ rep.identificador }}</span>
                  </div>
                </td>
                <td>
                  <input type="hidden" name="rep_id_{{ loop.index0 }}" value="{{ rep.identificador }}">
                  <input type="hidden" name="rep_nome_{{ loop.index0 }}" value="{{ rep.nome }}">
                  <input class="currency-input" name="meta_valor_{{ loop.index0 }}" type="text" value="{% if rep.meta_valor %}{{ "{:,.2f}".format(rep.meta_valor).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% endif %}" placeholder="R$ 0,00">
                </td>
                <td>
                  <input name="meta_pedidos_{{ loop.index0 }}" type="number" min="0" step="1" value="{{ rep.meta_pedidos or '' }}" placeholder="0">
                </td>
                <td>
                  {% if rep.status == 'Cadastrada' %}
                  <span class="status-pill status-good">Cadastrada</span>
                  {% else %}
                  <span class="status-pill status-neutral">Pendente</span>
                  {% endif %}
                </td>
                <td>
                  <button class="btn-ghost" type="submit" name="salvar_id" value="{{ loop.index0 }}">Salvar</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="form-actions">
          <button class="btn-primary" type="submit">Salvar tudo</button>
          <button class="btn-outline" type="submit" name="action" value="zerar" data-confirm="true">Zerar metas do período</button>
        </div>
      </form>
      {% endif %}
    </section>
  </main>

  <footer>
    <p>Metas individuais ficam armazenadas localmente e são usadas no painel executivo.</p>
  </footer>

  {% if message %}
  <div class="toast {{ message_type }}" id="toastMessage">{{ message }}</div>
  {% endif %}

  <script>
    const toast = document.getElementById('toastMessage');
    if (toast) {
      setTimeout(() => toast.classList.add('visible'), 100);
      setTimeout(() => toast.classList.remove('visible'), 4200);
    }

    const defaultButton = document.getElementById('applyDefault');
    const defaultInput = document.getElementById('metaPadrao');
    if (defaultButton && defaultInput) {
      defaultButton.addEventListener('click', () => {
        const value = defaultInput.value.trim();
        if (!value) {
          return;
        }
        document.querySelectorAll('.currency-input').forEach(input => {
          if (!input.value.trim()) {
            input.value = value;
          }
        });
      });
    }

    document.querySelectorAll('[data-confirm="true"]').forEach(button => {
      button.addEventListener('click', (event) => {
        if (!confirm('Tem certeza que deseja zerar todas as metas deste período?')) {
          event.preventDefault();
        }
      });
    });
  </script>
</body>
</html>
